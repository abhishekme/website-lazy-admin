{"version":3,"file":"lookup.js","sourceRoot":"","sources":["../../../../temp/inline/lookups/lookup.ts"],"names":[],"mappings":"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","sourcesContent":["import {Component, ContentChild, ChangeDetectionStrategy, Input, Output, EventEmitter, ElementRef, Renderer2, ChangeDetectorRef, ViewChild, TemplateRef, OnChanges} from '@angular/core';\nimport {Observable} from 'rxjs/Observable';\nimport {BehaviorSubject} from 'rxjs/BehaviorSubject';\nimport 'rxjs/add/observable/of';\nimport 'rxjs/add/operator/skip';\nimport 'rxjs/add/operator/do';\nimport 'rxjs/add/operator/debounceTime';\nimport 'rxjs/add/operator/distinctUntilChanged';\nimport 'rxjs/add/operator/switchMap';\nimport 'rxjs/add/operator/publish';\nimport {NglLookupItemTemplate, NglLookupLabelTemplate} from './item';\nimport {NglLookupScopeItem} from './scope-item';\nimport {uniqueId, isObject} from '../util/util';\n\n@Component({\n  selector: 'ngl-lookup',\n  changeDetection: ChangeDetectionStrategy.OnPush,\n  template: `\n    <div class=\"slds-lookup slds-form-element\" data-select=\"single\" [attr.data-scope]=\"polymorphic ? 'multi' : 'single'\" [class.slds-is-open]=\"expanded\"><label class=\"slds-form-element__label\" *ngIf=\"_label\" [attr.for]=\"inputId\" [nglInternalOutlet]=\"_label\"></label><div class=\"slds-form-element__control\" *ngIf=\"pick\"><div class=\"slds-pill_container\"><ngl-pill (nglPillRemove)=\"clear()\">{{resolveLabel(pick)}}</ngl-pill></div></div><div class=\"slds-form-element__control slds-grid\" *ngIf=\"!pick\" [class.slds-box--border]=\"polymorphic\"><ngl-internal-lookup-scope *ngIf=\"polymorphic\" [open]=\"openScope\" (openChange)=\"onScopeOpen($event)\" [scope]=\"polymorphic\" (scopeChange)=\"scopeSelect($event)\"><ng-content select=\"[nglPolymorphicLabel]\"></ng-content></ngl-internal-lookup-scope><div class=\"slds-input-has-icon slds-grow\" [ngClass]=\"{'slds-input-has-icon--right': searchIcon }\"><svg class=\"slds-input__icon slds-icon-text-default\" nglIcon=\"search\" *ngIf=\"searchIcon\"></svg><input class=\"slds-input slds-lookup__search-input\" #lookupInput [id]=\"inputId\" type=\"text\" aria-autocomplete=\"list\" role=\"combobox\" autocomplete=\"off\" [attr.aria-expanded]=\"!!expanded\" [attr.aria-activedescendant]=\"optionId(activeIndex)\" [ngModel]=\"inputValue\" (ngModelChange)=\"onInputChange($event)\" (keydown.Esc)=\"close($event)\" [placeholder]=\"placeholder || ''\" (keydown.ArrowDown)=\"moveActive($event, 1)\" (keydown.ArrowUp)=\"moveActive($event, -1)\" (keydown.Enter)=\"pickActive($event)\" [ngClass]=\"{'slds-input': !polymorphic, 'slds-input--bare': polymorphic}\"></div></div><div class=\"slds-lookup__menu\" *ngIf=\"expanded\" role=\"listbox\" [ngSwitch]=\"!!itemTemplate\"><ng-content select=\"[nglLookupHeader]\"></ng-content><ul class=\"slds-lookup__list\" role=\"presentation\" *ngSwitchCase=\"false\"><li *ngIf=\"noResults\"><div class=\"slds-lookup__item--label\">{{noResultsText}}</div></li><li *ngFor=\"let item of suggestions; let i=index\" (click)=\"handlePick(item)\" [ngClass]=\"{'slds-dropdown__item--active': i === activeIndex }\"><a class=\"slds-lookup__item-action\" [id]=\"optionId(i)\" role=\"option\">{{resolveLabel(item)}}</a></li></ul><ul class=\"slds-lookup__list\" role=\"presentation\" *ngSwitchCase=\"true\"><li *ngIf=\"noResults\"><div class=\"slds-lookup__item--label\">{{noResultsText}}</div></li><li *ngFor=\"let item of suggestions; let i=index\" (click)=\"handlePick(item)\" [ngClass]=\"{'slds-dropdown__item--active': i === activeIndex }\"><a class=\"slds-lookup__item-action\" [id]=\"optionId(i)\" role=\"option\"><ng-template [ngTemplateOutlet]=\"itemTemplate.templateRef\" [ngTemplateOutletContext]=\"{ $implicit: item }\"></ng-template></a></li></ul></div></div>\n  `,\n  styles: [\n    `.slds-dropdown__item--active > a {\n        outline: 0;\n        text-decoration: none;\n        background-color: #f4f6f9;\n    }`,\n  ],\n})\nexport class NglLookup implements OnChanges {\n\n  @ContentChild(NglLookupItemTemplate) itemTemplate: NglLookupItemTemplate;\n  @ContentChild(NglLookupScopeItem) polymorphic: NglLookupScopeItem;\n\n  @Input() placeholder: string;\n  @Input() noResultsText = 'No results found';\n  @Input() searchIcon: boolean = true;\n\n  openScope: boolean = false;\n\n  @Input() set value(value: string) {\n    if (value !== this.inputSubject.getValue()) {\n      this.inputValue = value;\n      this.inputSubject.next(value);\n    }\n  }\n  @Output() valueChange = new EventEmitter<string>();\n\n  @Input() lookup: Function;\n  @Input() field: string;\n\n  pick: any;\n  @Input('pick') set setPick(pick: any) {\n    this.inputValue = this.resolveLabel(pick);\n    this.pick = pick;\n  }\n  @Output() pickChange = new EventEmitter();\n\n  @Input() label: string;\n  @ContentChild(NglLookupLabelTemplate) labelTemplate: NglLookupLabelTemplate;\n\n  @ViewChild('lookupInput') inputEl: ElementRef;\n\n  @Input() debounce: number = 200;\n\n  inputId = uniqueId('lookup_input');\n\n  _label: string | TemplateRef<any>;\n\n  private globalClickUnsubscriber: Function = null;\n  private _open = false;\n  @Input() set open(_open: boolean) {\n    if (this.open === _open) return;\n    if (_open) {\n      this.globalClickUnsubscriber = this.renderer.listen('document', 'click', ($event: MouseEvent) => {\n        this.globalClickHandler($event);\n        this.detector.markForCheck();\n      });\n    } else {\n      this.activeIndex = -1;\n      this.unsubscribeGlobalClick();\n    }\n    this._open = _open;\n  }\n  get open(): boolean {\n    return this._open;\n  }\n  private inputValue = '';\n  private inputSubject = new BehaviorSubject(undefined);\n  private suggestions: any[];\n  private noResults: boolean = false;\n  private activeIndex: number = -1;\n  private lastUserInput: string;\n  private pendingFocus = false;\n\n  constructor(private element: ElementRef, private renderer: Renderer2, private detector: ChangeDetectorRef) {}\n\n  handlePick(item: any) {\n    this.pickChange.emit(item);\n  }\n\n  onInputChange(value: string) {\n    this.inputSubject.next(value);\n  }\n\n  ngOnInit() {\n    let valueStream = this.inputSubject.skip(1)\n      .do((value: string) => {\n        this.lastUserInput = value;\n        this.activeIndex = -1;\n        this.valueChange.emit(value);\n      });\n\n    if (this.debounce > 0) {\n      valueStream = valueStream.debounceTime(this.debounce);\n    }\n\n    const suggestions$ = valueStream\n      .distinctUntilChanged()\n      .switchMap((value: string) => {\n        const suggestions = this.lookup(value);\n        return suggestions instanceof Observable ? suggestions : Observable.of(suggestions);\n      })\n      .publish().refCount(); // Single instance\n\n    suggestions$.subscribe((suggestions: any[]) => {\n      this.suggestions = suggestions;\n      this.noResults = Array.isArray(suggestions) && !suggestions.length;\n      this.open = !!suggestions;\n      this.detector.markForCheck();\n    });\n  }\n\n  ngOnChanges(changes?: any) {\n    this._label = this.labelTemplate ? this.labelTemplate.templateRef : (this.label || '');\n  }\n\n  resolveLabel(item: any) {\n    return this.field && isObject(item) ? item[this.field] : item;\n  }\n\n  close(evt: KeyboardEvent = null) {\n    if (evt) {\n      evt.preventDefault();\n    }\n    this.open = false;\n  }\n\n  globalClickHandler($event: MouseEvent) {\n    const { nativeElement } = this.element;\n    if ($event.target === nativeElement || nativeElement.contains($event.target)) {\n      return;\n    }\n    this.open = false;\n  }\n\n  optionId(index: number) {\n    return index < 0 ? null : `${this.inputId}_active_${index}`;\n  }\n\n  pickActive() {\n    if (this.activeIndex < 0) return;\n    this.handlePick(this.suggestions[this.activeIndex]);\n  }\n\n  moveActive(evt: KeyboardEvent, moves: number) {\n    evt.preventDefault();\n    if (!this.expanded) return;\n\n    this.activeIndex = Math.max(-1, Math.min(this.activeIndex + moves, this.suggestions.length - 1));\n\n    // Update input value based on active option\n    const value = this.activeIndex === -1 ? this.lastUserInput : this.resolveLabel(this.suggestions[this.activeIndex]);\n    this.inputValue = value;\n  }\n\n  onScopeOpen(open: boolean) {\n    if (open) {\n      this.close();\n    }\n    this.openScope = open;\n  }\n\n  scopeSelect(scope: any) {\n    this.openScope = false;\n    this.focus();\n    this.polymorphic.scopeChange.emit(scope);\n  }\n\n  ngAfterViewChecked() {\n    if (this.pendingFocus && !this.pick) {\n      this.focus();\n    }\n    this.pendingFocus = false;\n  }\n\n  clear() {\n    this.pickChange.emit(null);\n    this.pendingFocus = true;\n  }\n\n  focus() {\n    this.inputEl.nativeElement.focus();\n  }\n\n  // Whether menu is expanded\n  get expanded(): boolean {\n    return this.open && !this.pick;\n  }\n\n  ngOnDestroy() {\n    this.unsubscribeGlobalClick();\n  }\n\n  private unsubscribeGlobalClick() {\n    if (!this.globalClickUnsubscriber) return;\n    this.globalClickUnsubscriber();\n    this.globalClickUnsubscriber = null;\n  }\n}\n"]}